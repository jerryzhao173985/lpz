# fscanf Vulnerability Report - selforg Component

## Summary

Found multiple instances of `fscanf` calls with unbounded `%s` format specifiers that can lead to buffer overflow vulnerabilities. These occur when `fscanf` reads string data without limiting the number of characters, potentially writing beyond buffer boundaries.

## Vulnerability Pattern

The vulnerable pattern is:
```c
char buffer[128];
fscanf(f, "%s", buffer);  // VULNERABLE: No field width limit
```

Should be:
```c
char buffer[128];
fscanf(f, "%127s", buffer);  // SAFE: Field width limit prevents overflow
```

## Affected Files

### 1. `controller/multireinforce.cpp`
- **Line 364**: `fscanf(f,"%s\n", buffer)` with `char buffer[128]`
- **Risk**: High - Direct user input without bounds checking
- **Fix**: Change to `"%127s\n"`

### 2. `controller/multilayerffnn.cpp`
- **Line 247**: `fscanf(f,"%s\n", buffer)` with buffer size unknown
- **Risk**: High - Neural network configuration loading
- **Fix**: Add field width based on buffer declaration

### 3. `controller/neuralgas.cpp`
- **Lines 167, 169, 171, 173**: Multiple `fscanf(f,"%s\n", buffer)` calls
- **Risk**: High - Multiple unbounded reads in sequence
- **Fix**: Add field width limits to all instances

### 4. `controller/som.cpp`
- **Lines 205, 207, 209, 211, 213**: Multiple `fscanf(f,"%s\n", buffer)` with `char buffer[128]`
- **Risk**: High - Self-organizing map configuration loading
- **Fix**: Change all to `"%127s\n"`

### 5. `controller/onelayerffnn.cpp`
- **Line 50**: `fscanf(f,"%s\n", buffer)`
- **Risk**: High - Neural network layer configuration
- **Fix**: Add appropriate field width

### 6. `matrix/matrix.cpp`
- **Line 199**: `fscanf(f, "%s ", buffer)` with `char buffer[128]`
- **Risk**: High - Matrix data loading, could be exploited with large numbers
- **Fix**: Change to `"%127s "`

### 7. `simulations/manipuexperts/multiexpertsubopt.cpp`
- **Lines 248, 250**: `fscanf(f,"%s\n", buffer)`
- **Risk**: Medium - Simulation configuration
- **Fix**: Add field width limits

### 8. `simulations/manipuexperts/multiexpertpair.cpp`
- **Lines 311, 313**: `fscanf(f,"%s\n", buffer)`
- **Risk**: Medium - Simulation configuration
- **Fix**: Add field width limits

### 9. `simulations/manipuexperts/main.cpp`
- **Line 72**: `fscanf(f,"%lf%i%lf%lf%lf",...)` 
- **Risk**: Low - No string format, but missing error checking
- **Fix**: Add return value checking

## Security Impact

These vulnerabilities could lead to:
1. **Buffer Overflow**: Writing beyond allocated memory
2. **Code Execution**: Potential arbitrary code execution if exploited
3. **Denial of Service**: Application crashes from corrupted memory
4. **Data Corruption**: Overwriting adjacent memory structures

## Recommended Fixes

### Immediate Actions
1. Run the provided fix scripts:
   ```bash
   cd selforg
   ./fix_fscanf_detailed.py
   ```

2. Manual review of changes:
   ```bash
   git diff
   ```

### Long-term Improvements
1. **Replace fscanf with safer alternatives**:
   ```c
   // Instead of:
   fscanf(f, "%s", buffer);
   
   // Use:
   if (fgets(buffer, sizeof(buffer), f)) {
       // Remove newline if present
       buffer[strcspn(buffer, "\n")] = '\0';
   }
   ```

2. **Add input validation**:
   ```c
   if (fscanf(f, "%127s", buffer) == 1) {
       // Validate the content
       if (strlen(buffer) > expected_max) {
           // Handle error
       }
   }
   ```

3. **Use C++ streams** where possible:
   ```cpp
   std::ifstream file(filename);
   std::string buffer;
   if (file >> buffer) {
       // Automatically safe from buffer overflow
   }
   ```

## Testing Recommendations

After applying fixes:
1. Compile with security flags: `-D_FORTIFY_SOURCE=2 -fstack-protector-strong`
2. Test with intentionally malformed input files
3. Use static analysis tools: `cppcheck`, `clang-tidy`
4. Consider fuzzing the file parsing code

## Prevention

1. Add coding guidelines requiring field width for all `%s` format specifiers
2. Use static analysis in CI/CD pipeline
3. Regular security audits of file I/O operations
4. Prefer modern C++ I/O over C-style functions